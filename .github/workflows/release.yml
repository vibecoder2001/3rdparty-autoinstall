name: Release

on:
  push:
    tags:
      - "v*"
      - "*.*"
      - "*.*.*"

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install NSIS (Chocolatey)
        shell: powershell
        run: |
          choco install nsis -y

      - name: Fetch and verify driver CABs
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
          .\tools\fetch-cabs.ps1

      - name: Build with makensis
        shell: powershell
        run: |
          $nsi = "3rdpartyautoinstall.nsi"
          if (!(Test-Path $nsi)) { throw "NSIS script not found: $nsi" }
          & "${env:ProgramFiles(x86)}\NSIS\makensis.exe" /V4 $nsi

      - name: Compute SHA256 for installer
        id: hashes
        shell: powershell
        run: |
          $exe = Get-ChildItem -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) { throw "No installer EXE found in repo root" }
          $hash = (Get-FileHash $exe.FullName -Algorithm SHA256).Hash.ToLower()
          "exe_path=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "exe_name=$($exe.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "exe_sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create GitHub Release + upload installer
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: ${{ steps.hashes.outputs.exe_path }}
          body: |
            ⚠️ This release is untested / lightly tested.

            Installer: `${{ steps.hashes.outputs.exe_name }}`
            SHA256: `${{ steps.hashes.outputs.exe_sha256 }}`
